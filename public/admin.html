<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FY Bot ‚Äî Multi-Client Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #2d3748;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #fff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .tab-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .tab-btn.active {
      background: #fff;
      color: #667eea;
      border-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      font-size: 14px;
    }
    input, select, textarea {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #f7fafc;
      color: #4a5568;
      border: 2px solid #e2e8f0;
    }
    .btn-secondary:hover {
      background: #edf2f7;
    }
    .btn-danger {
      background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
      color: #fff;
    }
    .btn-success {
      background: linear-gradient(135deg, #68d391 0%, #38a169 100%);
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    th {
      background: #f7fafc;
      color: #667eea;
      font-weight: 600;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-paid {
      background: #c6f6d5;
      color: #22543d;
    }
    .status-pending {
      background: #feebc8;
      color: #7c2d12;
    }
    .status-failed {
      background: #fed7d7;
      color: #742a2a;
    }
    .status-connected {
      background: #c6f6d5;
      color: #22543d;
    }
    .status-disconnected {
      background: #fed7d7;
      color: #742a2a;
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar input {
      flex: 1;
      min-width: 250px;
    }
    .info-box {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-box p {
      margin: 0;
      color: #2c5282;
      font-size: 14px;
    }
    .client-card {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    .client-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .client-id {
      font-weight: 700;
      color: #667eea;
      font-size: 18px;
    }
    .client-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .client-info-item {
      display: flex;
      flex-direction: column;
    }
    .client-info-label {
      font-size: 12px;
      color: #718096;
      font-weight: 600;
    }
    .client-info-value {
      font-size: 14px;
      color: #2d3748;
      font-weight: 500;
    }
    .client-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="adminTitle">üéØ FY Bot Multi-Client Admin</h1>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('clients')">üë• Clients</button>
      <button class="tab-btn" onclick="switchTab('orders')">üì¶ Orders</button>
      <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
      <button class="tab-btn" onclick="switchTab('system')">üîß System</button>
    </div>

    <!-- Clients Tab -->
    <div id="tab-clients" class="tab-content active">
      <div class="card">
        <h2>üë• Connected WhatsApp Clients</h2>
        <div class="info-box">
          <p><strong>Multi-Client System:</strong> Each client can have its own WhatsApp connection, bot name, and admin number.</p>
        </div>
        <div id="clientsContainer">Loading clients...</div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="tab-orders" class="tab-content">
      <div class="card">
        <h2>üìã Order Management</h2>
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Search by order number, MPesa code, or phone number...">
          <select id="filterSelect">
            <option value="all">All Orders</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
            <option value="cancelled">Failed/Cancelled</option>
          </select>
          <button class="btn btn-primary" onclick="loadOrders()">üîç Search</button>
          <button class="btn btn-secondary" onclick="loadOrders()">üîÑ Refresh</button>
        </div>
        <div id="ordersContainer">Loading orders...</div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="tab-content">
      <div class="card">
        <h2>üîê Access Code Configuration</h2>
        <div class="info-box">
          <p><strong>Security:</strong> Users need this code to generate new QR codes and create WhatsApp clients.</p>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="access_code">Access Code</label>
            <input type="text" id="access_code" placeholder="4262">
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveAccessCode()">üíæ Update Access Code</button>
      </div>

      <div class="card">
        <h2>üéØ App Branding</h2>
        <div class="info-box">
          <p><strong>Customize:</strong> Set your app name that appears on the main page and admin panel.</p>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="app_name">App Name (Main Page Title)</label>
            <input type="text" id="app_name" placeholder="FY Bot">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ü§ñ Global Bot Settings</h2>
        <div class="info-box">
          <p><strong>Note:</strong> These settings apply to all clients. Individual client settings can override bot name and admin number.</p>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="bot_name">Default Bot Name</label>
            <input type="text" id="bot_name" placeholder="FY Bot">
          </div>
          <div class="form-group">
            <label for="admin_whatsapp">Default Admin WhatsApp</label>
            <input type="text" id="admin_whatsapp" placeholder="254712345678">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üí∞ Pricing & Limits</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="min_amount">Minimum Amount (KES)</label>
            <input type="number" id="min_amount" placeholder="10" min="1">
          </div>
          <div class="form-group">
            <label for="max_amount">Maximum Amount (KES)</label>
            <input type="number" id="max_amount" placeholder="1500" min="1">
          </div>
          <div class="form-group">
            <label for="discount_percent">Discount Percentage (%)</label>
            <input type="number" id="discount_percent" placeholder="0" min="0" max="100" step="0.1">
          </div>
          <div class="form-group">
            <label for="payment_poll_seconds">Payment Poll Timeout (seconds)</label>
            <input type="number" id="payment_poll_seconds" placeholder="20" min="5">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üîê Shadow Pay Configuration</h2>
        <div class="info-box">
          <p><strong>Shadow Pay</strong> is used for M-Pesa STK Push payments</p>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="shadow_api_key">Shadow Pay API Key</label>
            <input type="text" id="shadow_api_key" placeholder="Your Shadow Pay API Key">
          </div>
          <div class="form-group">
            <label for="shadow_api_secret">Shadow Pay API Secret</label>
            <input type="password" id="shadow_api_secret" placeholder="Your Shadow Pay API Secret">
          </div>
          <div class="form-group">
            <label for="shadow_account_id">Shadow Pay Account ID</label>
            <input type="text" id="shadow_account_id" placeholder="17">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üì° Statum Airtime API Configuration</h2>
        <div class="info-box">
          <p><strong>Statum</strong> is used for airtime delivery to recipient numbers</p>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="statum_consumer_key">Statum Consumer Key</label>
            <input type="text" id="statum_consumer_key" placeholder="Your Statum Consumer Key">
          </div>
          <div class="form-group">
            <label for="statum_consumer_secret">Statum Consumer Secret</label>
            <input type="password" id="statum_consumer_secret" placeholder="Your Statum Consumer Secret">
          </div>
        </div>
      </div>

      <div class="card">
        <button class="btn btn-primary" onclick="saveAllSettings()">üíæ Save All Settings</button>
      </div>
    </div>

    <!-- System Tab -->
    <div id="tab-system" class="tab-content">
      <div class="card">
        <h2>üîß System Information</h2>
        <div id="systemInfo">Loading system information...</div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token') || '';

    if (!token) {
      Swal.fire({
        icon: 'error',
        title: 'Unauthorized',
        text: 'No admin token provided. Redirecting...',
        confirmButtonColor: '#e53e3e'
      }).then(() => {
        window.location.href = '/';
      });
    }

    function api(path, opts = {}) {
      opts.headers = opts.headers || {};
      opts.headers['x-admin-token'] = token;
      return fetch(path, opts).then(r => r.json());
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
      
      if (tabName === 'clients') loadClients();
      if (tabName === 'settings') loadSettings();
      if (tabName === 'system') loadSystemInfo();
      if (tabName === 'orders') loadOrders();
    }

    async function loadClients() {
      const container = document.getElementById('clientsContainer');
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Loading clients...</p>';
      
      const result = await api('/admin/clients');
      
      if (!result.success) {
        Swal.fire({
          icon: 'error',
          title: 'Error Loading Clients',
          text: result.message || 'Failed to load clients',
          confirmButtonColor: '#e53e3e'
        });
        container.innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 20px;">Error loading clients</p>';
        return;
      }

      if (!result.clients.length) {
        container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 40px;">No clients connected yet. Generate a QR code from the main page to create your first client.</p>';
        return;
      }

      let html = '';
      result.clients.forEach(client => {
        const statusClass = client.status === 'connected' ? 'status-connected' : 'status-disconnected';
        const pauseBadge = client.isPaused ? '<span class="status-badge status-pending" style="margin-left: 8px;">‚è∏Ô∏è Paused</span>' : '';
        const bannedBadge = client.bannedUsersCount > 0 ? `<span class="status-badge" style="background: #fed7d7; color: #742a2a; margin-left: 8px;">üö´ ${client.bannedUsersCount} Banned</span>` : '';
        
        html += `
          <div class="client-card">
            <div class="client-header">
              <div class="client-id">üÜî ${client.id}</div>
              <div>
                <span class="status-badge ${statusClass}">${client.status}</span>
                ${pauseBadge}
                ${bannedBadge}
              </div>
            </div>
            <div class="client-info">
              <div class="client-info-item">
                <span class="client-info-label">Bot Name</span>
                <span class="client-info-value">${client.botName || 'Not set'}</span>
              </div>
              <div class="client-info-item">
                <span class="client-info-label">Admin Number</span>
                <span class="client-info-value">${client.adminNumber ? '+' + client.adminNumber : 'Not set'}</span>
              </div>
              <div class="client-info-item">
                <span class="client-info-label">Connected Number</span>
                <span class="client-info-value">${client.connectedNumber ? '+' + client.connectedNumber : 'Not connected'}</span>
              </div>
              <div class="client-info-item">
                <span class="client-info-label">Created At</span>
                <span class="client-info-value">${client.createdAt || 'N/A'}</span>
              </div>
            </div>
            <div class="client-actions">
              <button class="btn btn-success" onclick="manageClient('${client.id}')">‚öôÔ∏è Manage</button>
              ${client.isPaused ? 
                `<button class="btn btn-success" onclick="resumeClient('${client.id}')">‚ñ∂Ô∏è Resume</button>` :
                `<button class="btn btn-secondary" onclick="stopClient('${client.id}')">‚è∏Ô∏è Stop</button>`
              }
              <button class="btn btn-primary" onclick="restartClient('${client.id}')">üîÑ Restart</button>
              <button class="btn btn-primary" onclick="sendBulkMessage('${client.id}')">üì¢ Bulk Message</button>
              <button class="btn btn-danger" onclick="disconnectClient('${client.id}')">üîå Logout</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function manageClient(clientId) {
      const clientResult = await api(`/admin/client/${encodeURIComponent(clientId)}`);
      
      if (!clientResult.success) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load client details',
          confirmButtonColor: '#e53e3e'
        });
        return;
      }
      
      const client = clientResult.client;
      
      const { value: action } = await Swal.fire({
        title: `‚öôÔ∏è Manage Client`,
        html: `
          <div style="text-align: left; max-height: 400px; overflow-y: auto;">
            <h3 style="color: #667eea; margin-top: 0;">üìã ${client.botName || 'Client'}</h3>
            <p><strong>ID:</strong> ${client.id}</p>
            <p><strong>Status:</strong> ${client.status} ${client.isPaused ? '(Paused)' : ''}</p>
            <p><strong>Connected:</strong> ${client.connectedNumber ? '+' + client.connectedNumber : 'Not connected'}</p>
            <hr style="margin: 15px 0;">
            <p style="margin-bottom: 10px; font-weight: 600;">Select an action:</p>
          </div>
        `,
        showCancelButton: true,
        showConfirmButton: false,
        cancelButtonText: 'Close',
        html: `
          <div style="display: flex; flex-direction: column; gap: 10px; padding: 10px;">
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="editClientSettings('${clientId}'); Swal.close();">‚úèÔ∏è Edit Basic Settings</button>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="editClientCredentials('${clientId}'); Swal.close();">üîê Edit API Credentials</button>
            <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="manageBannedUsers('${clientId}'); Swal.close();">üö´ Manage Banned Users</button>
          </div>
        `,
        width: '500px'
      });
    }

    async function editClientSettings(clientId) {
      const clientResult = await api(`/admin/client/${encodeURIComponent(clientId)}`);
      if (!clientResult.success) return;
      const client = clientResult.client;
      
      const { value: formValues } = await Swal.fire({
        title: '‚úèÔ∏è Edit Basic Settings',
        html: `
          <div style="text-align: left;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Bot Name</label>
            <input id="swal-botname" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" value="${client.botName || ''}" placeholder="FY Bot">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Admin WhatsApp Number</label>
            <input id="swal-admin" class="swal2-input" style="margin: 0; width: 100%;" value="${client.adminNumber || ''}" placeholder="254712345678">
            <p style="color: #718096; font-size: 12px; margin-top: 5px;">Format: 254XXXXXXXXX (Kenyan number)</p>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üíæ Save Changes',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#cbd5e0',
        focusConfirm: false,
        preConfirm: () => {
          return {
            botName: document.getElementById('swal-botname').value,
            adminNumber: document.getElementById('swal-admin').value
          }
        }
      });

      if (!formValues) return;

      const result = await api('/admin/update-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientId,
          botName: formValues.botName,
          adminNumber: formValues.adminNumber
        })
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Updated!',
          text: 'Client settings updated successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to update client',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function editClientCredentials(clientId) {
      const clientResult = await api(`/admin/client/${encodeURIComponent(clientId)}`);
      if (!clientResult.success) return;
      const client = clientResult.client;
      
      const { value: formValues } = await Swal.fire({
        title: 'üîê Edit API Credentials',
        html: `
          <div style="text-align: left; max-height: 500px; overflow-y: auto;">
            <h4 style="color: #667eea; margin-top: 0;">Shadow Pay Settings</h4>
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">API Key</label>
            <input id="swal-shadow-key" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" value="${client.shadowApiKey || ''}" placeholder="Shadow API Key">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">API Secret</label>
            <input id="swal-shadow-secret" class="swal2-input" type="password" style="margin: 0 0 15px 0; width: 100%;" value="${client.shadowApiSecret || ''}" placeholder="Shadow API Secret">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Payment Account ID</label>
            <input id="swal-shadow-id" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" value="${client.shadowAccountId || ''}" placeholder="10">
            <p style="color: #718096; font-size: 12px; margin: -10px 0 15px 0;">Leave empty to use defaults from settings</p>
            
            <h4 style="color: #667eea; margin-top: 20px;">Statum Airtime API</h4>
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Consumer Key</label>
            <input id="swal-statum-key" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" value="${client.statumConsumerKey || ''}" placeholder="Consumer Key">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Consumer Secret</label>
            <input id="swal-statum-secret" class="swal2-input" type="password" style="margin: 0; width: 100%;" value="${client.statumConsumerSecret || ''}" placeholder="Consumer Secret">
            <p style="color: #718096; font-size: 12px; margin-top: 5px;">Leave empty to use defaults from global settings</p>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üíæ Save Credentials',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#cbd5e0',
        width: '600px',
        focusConfirm: false,
        preConfirm: () => {
          return {
            shadowApiKey: document.getElementById('swal-shadow-key').value,
            shadowApiSecret: document.getElementById('swal-shadow-secret').value,
            shadowAccountId: document.getElementById('swal-shadow-id').value,
            statumConsumerKey: document.getElementById('swal-statum-key').value,
            statumConsumerSecret: document.getElementById('swal-statum-secret').value
          }
        }
      });

      if (!formValues) return;

      const result = await api('/admin/update-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientId,
          shadowApiKey: formValues.shadowApiKey,
          shadowApiSecret: formValues.shadowApiSecret,
          shadowAccountId: formValues.shadowAccountId,
          statumConsumerKey: formValues.statumConsumerKey,
          statumConsumerSecret: formValues.statumConsumerSecret
        })
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Updated!',
          text: 'Client credentials updated successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to update credentials',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function manageBannedUsers(clientId) {
      const clientResult = await api(`/admin/client/${encodeURIComponent(clientId)}`);
      if (!clientResult.success) return;
      const client = clientResult.client;
      
      let bannedHtml = '<h4 style="color: #667eea;">Banned Users</h4>';
      if (client.bannedUsers.length === 0) {
        bannedHtml += '<p style="color: #a0aec0;">No banned users</p>';
      } else {
        bannedHtml += '<div style="max-height: 200px; overflow-y: auto;">';
        client.bannedUsers.forEach(user => {
          bannedHtml += `
            <div style="background: #f7fafc; padding: 10px; margin: 5px 0; border-radius: 8px; border-left: 4px solid #e53e3e;">
              <strong>${user.phone}</strong><br>
              <small style="color: #718096;">Reason: ${user.reason || 'No reason'}</small><br>
              <small style="color: #718096;">Banned: ${user.bannedAt || 'N/A'}</small><br>
              <button class="btn btn-success" style="margin-top: 5px; padding: 4px 8px; font-size: 12px;" onclick="unbanUser('${clientId}', '${user.phone}')">Unban</button>
            </div>
          `;
        });
        bannedHtml += '</div>';
      }
      
      const { value: action } = await Swal.fire({
        title: 'üö´ Manage Banned Users',
        html: `
          <div style="text-align: left;">
            ${bannedHtml}
            <hr style="margin: 20px 0;">
            <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="banUser('${clientId}'); Swal.close();">‚ûï Ban New User</button>
          </div>
        `,
        showCancelButton: true,
        showConfirmButton: false,
        cancelButtonText: 'Close',
        width: '600px'
      });
    }

    async function banUser(clientId) {
      const { value: formValues } = await Swal.fire({
        title: 'üö´ Ban User',
        html: `
          <div style="text-align: left;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Phone Number</label>
            <input id="swal-phone" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" placeholder="254712345678">
            <p style="color: #718096; font-size: 12px; margin: -10px 0 15px 0;">Format: 254XXXXXXXXX</p>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Ban Reason</label>
            <textarea id="swal-reason" class="swal2-textarea" style="margin: 0; width: 100%;" placeholder="Enter reason for ban..."></textarea>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üö´ Ban User',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e53e3e',
        cancelButtonColor: '#cbd5e0',
        focusConfirm: false,
        preConfirm: () => {
          const phone = document.getElementById('swal-phone').value;
          if (!phone) {
            Swal.showValidationMessage('Phone number is required');
            return false;
          }
          return {
            phoneNumber: phone,
            reason: document.getElementById('swal-reason').value
          }
        }
      });

      if (!formValues) return;

      const result = await api('/admin/ban-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientId,
          phoneNumber: formValues.phoneNumber,
          reason: formValues.reason
        })
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ User Banned!',
          text: 'User has been banned successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to ban user',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function unbanUser(clientId, phoneNumber) {
      const result = await api('/admin/unban-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientId,
          phoneNumber: phoneNumber.replace('+', '')
        })
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ User Unbanned!',
          text: 'User has been unbanned successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        manageBannedUsers(clientId);
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to unban user',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function stopClient(clientId) {
      const result = await Swal.fire({
        title: '‚è∏Ô∏è Stop Client?',
        html: `This will pause the bot. Users will see a message that the bot is temporarily paused.<br><br>You can resume it anytime.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‚è∏Ô∏è Yes, Stop',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ed8936',
        cancelButtonColor: '#cbd5e0'
      });

      if (!result.isConfirmed) return;

      const response = await api('/admin/stop-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId })
      });

      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: '‚è∏Ô∏è Stopped!',
          text: 'Client stopped successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: response.message || 'Failed to stop client',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function resumeClient(clientId) {
      const response = await api('/admin/resume-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId })
      });

      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: '‚ñ∂Ô∏è Resumed!',
          text: 'Client resumed successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: response.message || 'Failed to resume client',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function disconnectClient(clientId) {
      const result = await Swal.fire({
        title: '‚ö†Ô∏è Logout Client?',
        html: `Are you sure you want to logout this client?<br><br><strong>${clientId}</strong><br><br>‚ö†Ô∏è <strong>This will completely log out the WhatsApp session.</strong><br>You will need to scan the QR code again to reconnect.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'üîå Yes, Logout',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e53e3e',
        cancelButtonColor: '#cbd5e0'
      });

      if (!result.isConfirmed) return;

      const response = await api('/admin/disconnect-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId })
      });

      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Logged Out!',
          text: 'Client logged out successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
        loadClients();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: response.message || 'Failed to logout client',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function loadOrders() {
      const search = document.getElementById('searchInput').value;
      const filter = document.getElementById('filterSelect').value;
      const container = document.getElementById('ordersContainer');
      
      container.innerHTML = 'Loading...';
      
      const result = await api(`/admin/orders?filter=${encodeURIComponent(filter)}&q=${encodeURIComponent(search)}`);
      
      if (!result.success) {
        Swal.fire({
          icon: 'error',
          title: 'Error Loading Orders',
          text: result.message,
          confirmButtonColor: '#e53e3e'
        });
        return;
      }

      if (!result.orders.length) {
        container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 40px;">No orders found</p>';
        return;
      }

      let html = '<table><thead><tr>';
      html += '<th>Order No</th><th>Client ID</th><th>Payer</th><th>Recipient</th><th>Amount</th><th>Payable</th><th>Status</th><th>MPesa Code</th><th>Actions</th>';
      html += '</tr></thead><tbody>';

      result.orders.forEach(order => {
        const statusClass = order.status === 'paid' ? 'status-paid' : 
                          order.status.includes('pending') ? 'status-pending' : 'status-failed';
        html += '<tr>';
        html += `<td><strong>${order.order_no}</strong></td>`;
        html += `<td style="font-size: 11px; color: #718096;">${order.client_id || 'N/A'}</td>`;
        html += `<td>${order.payer_number}</td>`;
        html += `<td>${order.recipient_number}</td>`;
        html += `<td>KES ${parseFloat(order.amount).toFixed(2)}</td>`;
        html += `<td>KES ${parseFloat(order.amount_payable).toFixed(2)}</td>`;
        html += `<td><span class="status-badge ${statusClass}">${order.status}</span></td>`;
        html += `<td>${order.transaction_code || 'N/A'}</td>`;
        html += `<td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="viewOrderDetails('${order.order_no}')">View</button></td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function viewOrderDetails(orderNo) {
      const result = await api(`/admin/order/${encodeURIComponent(orderNo)}`);
      if (!result.success) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load order details',
          confirmButtonColor: '#e53e3e'
        });
        return;
      }
      const o = result.order;
      
      Swal.fire({
        title: 'üì¶ Order Details',
        html: `
          <div style="text-align: left; line-height: 1.8;">
            <p><strong>Order Number:</strong> ${o.order_no}</p>
            <p><strong>Client ID:</strong> ${o.client_id || 'N/A'}</p>
            <p><strong>Payer:</strong> ${o.payer_number}</p>
            <p><strong>Recipient:</strong> ${o.recipient_number}</p>
            <p><strong>Amount:</strong> KES ${parseFloat(o.amount).toFixed(2)}</p>
            <p><strong>Payable Amount:</strong> KES ${parseFloat(o.amount_payable).toFixed(2)}</p>
            <p><strong>Discount:</strong> ${o.discount_percent}%</p>
            <p><strong>Status:</strong> ${o.status}</p>
            <p><strong>MPesa Code:</strong> ${o.transaction_code || 'N/A'}</p>
            <p><strong>Airtime Status:</strong> ${o.airtime_status || 'N/A'}</p>
            <p><strong>Created:</strong> ${o.created_at}</p>
            <p><strong>Updated:</strong> ${o.updated_at}</p>
          </div>
        `,
        confirmButtonText: 'Close',
        confirmButtonColor: '#667eea',
        width: '600px'
      });
    }

    async function loadSettings() {
      const result = await api('/admin/settings');
      if (!result.success) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load settings',
          confirmButtonColor: '#e53e3e'
        });
        return;
      }

      const s = result.settings;
      
      document.getElementById('access_code').value = s.access_code || '';
      document.getElementById('app_name').value = s.app_name || 'FY Bot';
      document.getElementById('admin_whatsapp').value = s.admin_whatsapp || '';
      document.getElementById('bot_name').value = s.bot_name || '';
      document.getElementById('min_amount').value = s.min_amount || '';
      document.getElementById('max_amount').value = s.max_amount || '';
      document.getElementById('discount_percent').value = s.discount_percent || '';
      document.getElementById('payment_poll_seconds').value = s.payment_poll_seconds || '';
      document.getElementById('shadow_api_key').value = s.shadow_api_key || '';
      document.getElementById('shadow_api_secret').value = s.shadow_api_secret || '';
      document.getElementById('shadow_account_id').value = s.shadow_account_id || '';
      document.getElementById('statum_consumer_key').value = s.statum_consumer_key || '';
      document.getElementById('statum_consumer_secret').value = s.statum_consumer_secret || '';
      
      document.getElementById('adminTitle').textContent = `üéØ ${s.app_name || 'FY Bot'} Multi-Client Admin`;
      document.title = `${s.app_name || 'FY Bot'} ‚Äî Admin Dashboard`;
    }

    async function saveAccessCode() {
      const accessCode = document.getElementById('access_code').value;
      
      if (!accessCode) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Code',
          text: 'Please enter an access code',
          confirmButtonColor: '#e53e3e'
        });
        return;
      }

      const result = await api('/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ access_code: accessCode })
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Updated!',
          text: 'Access code updated successfully',
          confirmButtonColor: '#38a169',
          timer: 2000
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to update access code',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function saveAllSettings() {
      const payload = {
        access_code: document.getElementById('access_code').value,
        app_name: document.getElementById('app_name').value,
        admin_whatsapp: document.getElementById('admin_whatsapp').value,
        bot_name: document.getElementById('bot_name').value,
        min_amount: document.getElementById('min_amount').value,
        max_amount: document.getElementById('max_amount').value,
        discount_percent: document.getElementById('discount_percent').value,
        payment_poll_seconds: document.getElementById('payment_poll_seconds').value,
        shadow_api_key: document.getElementById('shadow_api_key').value,
        shadow_api_secret: document.getElementById('shadow_api_secret').value,
        shadow_account_id: document.getElementById('shadow_account_id').value,
        statum_consumer_key: document.getElementById('statum_consumer_key').value,
        statum_consumer_secret: document.getElementById('statum_consumer_secret').value
      };

      const result = await api('/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Saved!',
          text: 'All settings saved successfully',
          confirmButtonColor: '#38a169',
          timer: 2000,
          timerProgressBar: true
        });
        loadSettings();
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Error',
          text: result.message || 'Failed to save settings',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    async function loadSystemInfo() {
      const container = document.getElementById('systemInfo');
      const result = await api('/admin/system-info');
      
      if (!result.success) {
        container.innerHTML = '<p>Error loading system info</p>';
        return;
      }

      const info = result.info;
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div>
            <strong>Platform:</strong> ${info.platform || 'Unknown'}
          </div>
          <div>
            <strong>Node Version:</strong> ${info.nodeVersion || 'Unknown'}
          </div>
          <div>
            <strong>Total Orders:</strong> ${info.totalOrders || 0}
          </div>
          <div>
            <strong>Total Clients:</strong> ${info.totalClients || 0}
          </div>
          <div>
            <strong>Uptime:</strong> ${Math.floor(info.uptime / 60)} minutes
          </div>
        </div>
      `;
    }

    async function restartClient(clientId) {
      const result = await Swal.fire({
        title: 'üîÑ Restart Client?',
        html: `Are you sure you want to restart client <strong>${clientId}</strong>?<br><br>The bot will restart and may require re-scanning QR code if session is corrupted.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'üîÑ Yes, Restart',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#cbd5e0'
      });
      
      if (!result.isConfirmed) return;
      
      Swal.fire({
        title: 'üîÑ Restarting...',
        html: 'Please wait while the client restarts...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      const apiResult = await api('/admin/restart-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId })
      });
      
      if (apiResult.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Restart Initiated!',
          text: apiResult.message,
          confirmButtonColor: '#38a169',
          timer: 3000
        });
        setTimeout(() => loadClients(), 2000);
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Restart Failed',
          text: apiResult.message || 'Failed to restart client',
          confirmButtonColor: '#e53e3e'
        });
      }
    }
    
    async function sendBulkMessage(clientId) {
      const { value: formValues } = await Swal.fire({
        title: 'üì¢ Send Bulk Message',
        html: `
          <div style="text-align: left;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Message Text</label>
            <textarea id="swal-bulk-message" class="swal2-textarea" style="margin: 0 0 15px 0; width: 100%; min-height: 120px;" placeholder="Enter your message..."></textarea>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Image URL (Optional)</label>
            <input id="swal-bulk-image" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" placeholder="https://example.com/image.jpg">
            <p style="color: #718096; font-size: 12px; margin: -10px 0 15px 0;">If provided, image will be sent with the message as caption</p>
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Send To</label>
            <select id="swal-bulk-recipients" class="swal2-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
              <option value="all_connected">All Connected Users (from orders)</option>
            </select>
            <p style="color: #718096; font-size: 12px; margin: 5px 0 0 0;">Messages will be sent to all unique phone numbers from this client's orders</p>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üì¢ Send Bulk Message',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#cbd5e0',
        width: '600px',
        focusConfirm: false,
        preConfirm: () => {
          const message = document.getElementById('swal-bulk-message').value;
          const imageUrl = document.getElementById('swal-bulk-image').value;
          
          if (!message && !imageUrl) {
            Swal.showValidationMessage('Please enter a message or image URL');
            return false;
          }
          
          return {
            message: message,
            imageUrl: imageUrl,
            recipients: document.getElementById('swal-bulk-recipients').value
          }
        }
      });
      
      if (!formValues) return;
      
      Swal.fire({
        title: 'üì¢ Sending Messages...',
        html: 'Please wait while we send messages to all recipients...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      const apiResult = await api('/admin/bulk-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientId,
          message: formValues.message,
          imageUrl: formValues.imageUrl,
          recipients: formValues.recipients
        })
      });
      
      if (apiResult.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Messages Sent!',
          html: `
            <div style="text-align: left;">
              <p><strong>Total Recipients:</strong> ${apiResult.total || 0}</p>
              <p><strong>Successfully Sent:</strong> ${apiResult.success || 0}</p>
              <p><strong>Failed:</strong> ${apiResult.failed || 0}</p>
            </div>
          `,
          confirmButtonColor: '#38a169'
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Failed',
          text: apiResult.message || 'Failed to send bulk messages',
          confirmButtonColor: '#e53e3e'
        });
      }
    }

    // Load initial data
    loadClients();
  </script>
</body>
</html>
